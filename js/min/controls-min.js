function boxClicked(e){var o=!0,t=dataController.GetByID(parseInt(e.name));t.js_trigger&&(o=!1,o||keywordReturn(t.js_trigger)),boxid=parseInt(e.name),(o||t.js_trigger)&&(window.location.href="#/"+t.overlay+"/"+t.slug+"/"+t.type)}function mouseCursor(e){switch(e){case"grab":$("body").css({cursor:"grab",cursor:"-webkit-grab"});break;case"grabbing":$("body").css({cursor:"grabbing",cursor:"-webkit-grabbing"});break;case"point":$("body").css({cursor:"pointer"});break;case"normal":default:$("body").css({cursor:"default"})}}function renderMouseListener(){if(!mTouchDown&&!overlay&&!cameraController.animating){raycaster.setFromCamera(mouse,camera);var e=raycaster.intersectObjects(scene.children);if(e.length>0&&"undefined"!=typeof e[0]&&"undefined"!=typeof e[0].face)if(5==e[0].face.a&&7==e[0].face.b||7==e[0].face.a&&2==e[0].face.b){mouseCursor("point");var o=(new THREE.Vector3).setFromMatrixPosition(e[0].object.matrixWorld),t=(new THREE.Box3).setFromObject(e[0].object).size(),a=o.z+t.z/2+mouseSpotZ;mouseSpot.position.set(o.x,o.y,a),mouseSpot.target.position.set(o.x,o.y,o.z),mouseSpot.intensity=1.1,mouseSpot.updateMatrixWorld(),mouseSpot.target.updateMatrixWorld()}else mouseCursor("grab"),mouseSpot.intensity=.2}}function fingerMouseDown(e){if(e.preventDefault(),isMobile&&e.touches.length<2){var o=e.touches[0];oldTouchX=o.pageX,oldTouchY=o.pageY,mouseMove(e),canvas.addEventListener("mousemove",fingerMouseDrag),mTouchDown=!0,didSingleClick=!0,mouseDownTimeout=setTimeout(function(){didSingleClick=!1},1e3*singleClickTimeout)}else oldTouchX=e.clientX,oldTouchY=e.clientY,canvas.addEventListener("mousemove",fingerMouseDrag),mTouchDown=!0,didSingleClick=!0,mouseDownTimeout=setTimeout(function(){didSingleClick=!1},1e3*singleClickTimeout)}function fingerMouseDrag(e){e.preventDefault(),mouseMove(e);var o,t,a,n;if(isMobile){var c=e.touches[0];o=c.pageX-oldTouchX,a=c.pageX,t=c.pageY-oldTouchY,n=c.pageY}else mTouchDown&&(o=e.clientX-oldTouchX,a=e.clientX,t=e.clientY-oldTouchY,n=e.clientY);xMove!=o&&(xMove=o,oldTouchX=a),yMove!=t&&(yMove=t,oldTouchY=n),mouseCursor("grabbing"),t=0===t?void 0:t/75,o=0===o?void 0:-o/75,3==e.which?cameraController.Zoom(t,void 0,void 0,!1):cameraController.Move(o,t,void 0,!1)}function fingerMouseUp(e){if(e.preventDefault(),mTouchDown=!1,clearTimeout(mouseDownTimeout),canvas.removeEventListener("mousemove",fingerMouseDrag),xMove<1&&xMove>-1&&yMove<1&&yMove>-1&&!pinched&&didSingleClick){raycaster.setFromCamera(mouse,camera);var o=raycaster.intersectObjects(scene.children);o.length>0&&"undefined"!=typeof o[0]&&"undefined"!=typeof o[0].face&&(5==o[0].face.a&&7==o[0].face.b||7==o[0].face.a&&2==o[0].face.b)&&boxClicked(o[0].object)}mouseCursor(),xMove=0,yMove=0,didSingleClick=!1,mUP=!1,mDOWN=!1,mRIGHT=!1,mDOWN=!1,oldScale=0,pinched=!1}function rightClick(e){}function mouseMove(e){e.preventDefault();var o=$("header").height();isMobile?(mouse.x=e.touches[0].pageX/$(canvasDiv).width()*2-1,mouse.y=2*-((e.touches[0].pageY-o)/$(canvasDiv).height())+1):(mouse.x=e.clientX/$(canvasDiv).width()*2-1,mouse.y=2*-((e.clientY-o)/$(canvasDiv).height())+1)}function zoomHandler(e){if(e.preventDefault(),e.shiftKey){var o=Math.max(-.02,Math.min(.02,e.wheelDelta||-e.detail));cameraController.Rotate(o,void 0,void 0,!1)}else if(e.ctrlKey){var o=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));cameraController.Zoom(-o)}else{var t=Math.max(-10,Math.min(10,e.wheelDeltaX||-e.detail)),a=Math.max(-10,Math.min(10,e.wheelDeltaY||-e.detail));cameraController.Pan(-t/15,a/15)}}function resetPinches(){var e=[],o=0;$(document).on("pinchstart",function(e){pinched=!0}),$(document).on("pinchmove",function(t){pinched=!0;var a=-10*(t.scale-o);o=t.scale,e.push(a),e.length>5&&e.shift(),cameraController.Zoom(a)}),$(document).on("pinchend",function(t){for(var a,n=0;n<e.length;n++)a+=e[n];average=a/e.length,cameraController.Zoom(10*average,void 0,1,!1,!0,TWEEN.Easing.Cubic.In),o=0,pinched=!1,$(document).off("pinchstart pinchmove pinchend"),resetPinches()})}function setupEventListeners(){canvas.addEventListener("touchstart",fingerMouseDown),canvas.addEventListener("mousedown",fingerMouseDown),canvas.addEventListener("touchend",fingerMouseUp),canvas.addEventListener("mouseup",fingerMouseUp),canvas.addEventListener("touchmove",fingerMouseDrag),canvas.addEventListener("mousewheel",zoomHandler),canvas.addEventListener("DOMMouseScroll",zoomHandler),canvas.addEventListener("mousemove",mouseMove),enableOnScreenController(),window.DeviceMotionEvent&&window.addEventListener("devicemotion",devMoveHandler,!1),onMouseLeftBrowserWindow(function(e){didSingleClick=!1,clearTimeout(mouseDownTimeout),fingerMouseUp(e)})}function onMouseLeftBrowserWindow(e){addEvent(document,"mouseout",function(o){o=o?o:window.event;var t=o.relatedTarget||o.toElement;t&&"HTML"!=t.nodeName||e(o)})}function addEvent(e,o,t){e.addEventListener?e.addEventListener(o,t,!1):e.attachEvent&&e.attachEvent("on"+o,t)}function enableOnScreenController(){isMobile?$("#controls").css("display","none"):($("#controls img").on("dragstart",function(e){e.preventDefault()}),$("#mapctrl-left").mousedown(function(){mLEFT=!0,$(this).mousemove(function(e){e.preventDefault(),mLEFT=!1})}).mouseup(function(){mLEFT=!1}),$("#mapctrl-right").mousedown(function(){mRIGHT=!0,$(this).mousemove(function(e){e.preventDefault(),mRIGHT=!1})}).mouseup(function(){mRIGHT=!1}),$("#mapctrl-up").mousedown(function(){mUP=!0,$(this).mousemove(function(e){e.preventDefault(),mUP=!1})}).mouseup(function(){mUP=!1}),$("#mapctrl-down").mousedown(function(){mDOWN=!0,$(this).mousemove(function(e){e.preventDefault(),mDOWN=!1})}).mouseup(function(){mDOWN=!1}),$("#mapctrl-zoomin").mousedown(function(){mGOOUT=!0,$(this).mousemove(function(e){e.preventDefault(),mGOOUT=!1})}).mouseup(function(){mGOOUT=!1}),$("#mapctrl-zoomout").mousedown(function(){mGOIN=!0,$(this).mousemove(function(e){e.preventDefault(),mGOIN=!1})}).mouseup(function(){mGOIN=!1}),$("#mapctrl-tilt").click(function(e){e.preventDefault();var o=cameraController.rotation.x,t=cameraController.constraints.R1,a=(cameraController.constraints.R1+cameraController.constraints.R2)/2,n=cameraController.constraints.R2;o>=t&&a>o?cameraController.Rotate(a,void 0,void 0,!0,!0):o>=a&&n>o?cameraController.Rotate(n,void 0,void 0,!0,!0):cameraController.Rotate(t,void 0,void 0,!0,!0)}))}$(document).keydown(function(e){38==e.which&&(e.preventDefault(),mUP=!0),40==e.which&&(e.preventDefault(),mDOWN=!0),37==e.which&&(e.preventDefault(),mLEFT=!0),39==e.which&&(e.preventDefault(),mRIGHT=!0),34==e.which&&(e.preventDefault(),mGOIN=!0),33==e.which&&(e.preventDefault(),mGOOUT=!0),36==e.which&&(e.preventDefault(),mROTUP=!0),35==e.which&&(e.preventDefault(),mROTDOWN=!0),closeMenu()}),$(document).keyup(function(e){38==e.which&&(e.preventDefault(),mUP=!1),40==e.which&&(e.preventDefault(),mDOWN=!1),37==e.which&&(e.preventDefault(),mLEFT=!1),39==e.which&&(e.preventDefault(),mRIGHT=!1),34==e.which&&(e.preventDefault(),mGOIN=!1),33==e.which&&(e.preventDefault(),mGOOUT=!1),36==e.which&&(e.preventDefault(),mROTUP=!1),35==e.which&&(e.preventDefault(),mROTDOWN=!1)}),resetPinches();var devMoveHandler=function(e){null===acc_fromx&&(acc_fromx=cameraController.camera.position.x),null===acc_tox&&(acc_tox=cameraController.camera.position.x),null===acc_fromy&&(acc_fromy=cameraController.camera.position.y),null===acc_toy&&(acc_toy=cameraController.camera.position.y),null===acc_totilt&&(acc_totilt=cameraController.camera.rotation.x),null===acc_fromtilt&&(acc_fromtilt=cameraController.camera.rotation.x);var o=e.rotationRate;if(null!==o&&(acc_arAlpha=o.alpha,isiOS||(acc_arAlpha=40*acc_arAlpha),acc_arBeta=o.beta,isiOS||(acc_arBeta=40*acc_arBeta)),mTouchDown||cameraController.animating)acc_toy=acc_fromy=cameraController.camera.position.y,acc_tox=acc_fromx=cameraController.camera.position.x;else{if(acc_fromx=camera.position.x,Math.abs(acc_arBeta)>10){var t=-acc_arBeta/45;acc_tox=acc_fromx+t}if(acc_fromy=camera.position.y,Math.abs(acc_arAlpha)>10){var a=acc_arAlpha/25;acc_toy=acc_fromy+a}cameraController.Move((acc_tox-acc_fromx)/acc_speed,(acc_toy-acc_fromy)/acc_speed,void 0,!1)}acc_az=Math.abs(1*e.accelerationIncludingGravity.z),null===acc_oldaz&&(acc_oldaz=acc_az),acc_fromtilt=camera.rotation.x,(acc_az>acc_oldaz+.5||acc_az<acc_oldaz-.5)&&(acc_totilt=.09*(acc_az-3),acc_oldaz=acc_az),cameraController.Rotate((acc_totilt-acc_fromtilt)/(2*acc_speed),void 0,void 0,!1)};