function render(){requestAnimationFrame(render),overlay||(mRIGHT&&moveCamX(.1),mLEFT&&moveCamX(-.1),mUP&&moveCamY(.1),mDOWN&&moveCamY(-.1),mGOIN&&(camera.position.z-=.1),mGOOUT&&(camera.position.z+=.1),xMove&&moveCamX(xMove/200*-1),yMove&&moveCamY(yMove/200),mROTUP&&camera.rotation.x<.9&&(camera.rotation.x+=.03),mROTDOWN&&camera.rotation.x>0&&(camera.rotation.x-=.03),renderer.render(scene,camera))}function init3D(){var e=new THREE.PlaneBufferGeometry(100,100),i=new THREE.MeshPhongMaterial({color:16776690,side:THREE.DoubleSide}),a=new THREE.Mesh(e,i);scene.add(a),a.position.z=-.2,light=new THREE.PointLight(16777215,1,50),light.position.set(0,0,4),scene.add(light),camera.position.z=5,initInterval=setInterval(function(){glCards.length>0&&(clearInterval(initInterval),initBuildings())},500),render()}function initBuildings(){var e=math.zeros(maxX,maxY),i=math.zeros(1,glCards.length);camMinHeight=0;for(var a=glCards,r=a.length,t=jitterX,n=jitterY,o=!1,m=0,s=1;maxY>=s;s++){for(var d=maxX;d>=1;d--){var l={},c=a[m];if("undefined"==typeof c){o=!0;break}if(1!=e.subset(math.index(s-1,maxX-d))){e.subset(math.index(s-1,maxX-d),1);var h;if(c.ysize>1)for(h=1;h<=c.xsize;h++)e.subset(math.index(s+h-1,maxX-d),1);if(c.xsize>1)for(h=1;h<=c.ysize;h++)e.subset(math.index(s-1,maxX-d+h),1);i.subset(math.index(0,r-a.length),1),a=a.splice(m,1),t*=-1,n*=-1;var g=gutterY*(c.ysize-1)+boxheight*c.ysize,x=gutterX*(c.xsize-1)+boxwidth*c.xsize,E=3*Math.random()+1;E/2+1>camMinHeight&&(camMinHeight=Math.ceil(E/2+2)),l.geometry=new THREE.BoxGeometry(x,g,E);var M=colors[Math.round(Math.random())];if(l.material=[new THREE.MeshLambertMaterial({color:M}),new THREE.MeshLambertMaterial({color:M}),new THREE.MeshLambertMaterial({color:M}),new THREE.MeshLambertMaterial({color:M}),new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture(c.img)}),new THREE.MeshLambertMaterial({color:M})],l.material[4].minFilter=THREE.NearestFilter,l.cube=new THREE.Mesh(l.geometry,new THREE.MeshFaceMaterial(l.material)),l.cube.name=m,scene.add(l.cube),objects.push(l.cube),l.cube.position.x=-d*gridSizex-(c.xsize-1)*gridSizex/2+t,l.cube.position.y=-s*gridSizey-(c.ysize-1)*gridSizey/2+n,o)break}}if(o)break}console.log("camera max: "+camMaxHeight+" min: "+camMinHeight)}function logMatrix(e){for(var i in e)for(var a in i)console.log(e[i][a])}var camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e4),scene=new THREE.Scene;scene.fog=new THREE.FogExp2(16776690,.18);var renderer=new THREE.WebGLRenderer({antialias:!0}),light=null,camMaxHeight=6.5,camMinHeight,objects=[],gridSizex=1.2,gridSizey=1.5,maxX=6,maxY=6,boxheight=1.3,boxwidth=1,gutterX=gridSizex-boxwidth,gutterY=gridSizey-boxheight,jitterX=.05,jitterY=.4,colors=[14755101,3909315],objects=[],initInterval;renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMapEnabled=!0,document.body.appendChild(renderer.domElement);