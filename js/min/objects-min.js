var _objects=function(){var t=this;this.MultiplyArray=function(t,i){if(2>t)return i;for(var e=i.slice(),n=1;t>=n;n++)e=e.concat(i);return this.ShuffleArray(e)},this.ShuffleArray=function(t){for(var i=t.length,e,n;0!==i;)n=Math.floor(Math.random()*i),i-=1,e=t[i],t[i]=t[n],t[n]=e;return t},this.dataController=function(t){this.data={},this.rawData=[],this.materials={c:{},t:{}},this.textures={},"undefined"!=typeof t&&this.SetData(t)},this.dataController.prototype.GetTexture=function(t){t.img in this.textures||(this.textures[t.img]=new THREE.ImageUtils.loadTexture(t.img),this.textures[t.img].wrapS=THREE.RepeatWrapping,this.textures[t.img].wrapT=THREE.RepeatWrapping);var i=this.textures[t.img];return 1==t.xsize?i.repeat.x=358/512:2==t.xsize&&(i.repeat.x=691/1024),1==t.ysize?i.repeat.y=435/512:2==t.ysize&&(i.repeat.y=947/1024),1==t.xsize&&1==t.ysize&&(i.repeat.x=306/512),i.offset.y=1-i.repeat.y,i},this.dataController.prototype.GetMaterial=function(t,i){var e=this.GetTexture(t);i in this.materials.c||(this.materials.c[i]=new THREE.MeshLambertMaterial({color:i})),t.img in this.materials.t||(this.materials.t[t.img]=new THREE.MeshLambertMaterial({map:e}));var n=this.materials.c[i],s=this.materials.t[t.img],o=[n,n,n,n,s,n];return o[4].minFilter=THREE.NearestFilter,o},this.dataController.prototype.SetData=function(t){for(var i=0;i<t.length;i++)this.data[parseInt(t[i].id)]=t[i];this.rawData=t,this.fuse=new Fuse(this.rawData,{keys:["tags"]}),this.fuseId=new Fuse(this.rawData,{keys:["tags"],id:"tags"})},this.dataController.prototype.GetByID=function(t){return this.data[t]},this.dataController.prototype.GetBySlug=function(t){for(var i=Object.keys(this.data),e=0;e<i.length;e++)if(this.data[i[e]].slug==t)return this.data[i[e]]},this.dataController.prototype.GetByType=function(t){for(var i=[],e=Object.keys(this.data),n=0;n<e.length;n++)this.data[e[n]].overlay==t&&i.push(this.data[e[n]]);return i},this.dataController.prototype.GetAllWithTag=function(t){return this.fuse.search(t)},this.dataController.prototype.GetIdsWithTag=function(t){return this.fuseId.search(t)},this.cameraController=function(t,i,e){if(this.scene=i,this.renderer=t,this.camera=e,this.constraints={X1:0,Y1:0,Z1:0,X2:0,Y2:0,Z2:0,R1:0,R2:0},this.origin={X:0,Y:0},this.animating=!1,enableBlur){this.depthOfField=new THREEx.DepthOfField(t);var n=new dat.GUI;debugBlur&&(THREEx.depthOfFieldDatGui(this.depthOfField,n),this.depthOfField.uniforms.focus.value=5,console.log(this.depthOfField))}},this.cameraController.prototype.Render=function(){enableBlur&&this.depthOfField.render(this.scene,this.camera)},this.cameraController.prototype.CenterOnCity=function(t,i){if("undefined"==typeof i&&(i=!1),-1==t)return console.log("Error (cameraController.CenterOnCity): Tried to Center on an invalid city"),0;var e={X1:t.extents.X1-camXExtents,Y1:t.extents.Y1-camYExtents,Z1:t.extents.Z1-camZ1Extents,X2:t.extents.X2+camXExtents,Y2:t.extents.Y2+camYExtents,Z2:t.extents.Z2+camZ2Extents,R1:camRotateMin,R2:camRotateMax};this.SetConstraints(e),i?this.Move(t.midpoint.X,t.midpoint.Y):this.Pan(t.midpoint.X,t.midpoint.Y,void 0,void 0,camPanToCityAnimationTime,!0,!1),this.SetOrigin(t.midpoint.X,t.midpoint.Y)},this.cameraController.prototype.SetConstraints=function(t){"undefined"!=typeof t.X1&&(this.constraints.X1=t.X1),"undefined"!=typeof t.Y1&&(this.constraints.Y1=t.Y1),"undefined"!=typeof t.Z1&&(this.constraints.Z1=t.Z1),"undefined"!=typeof t.R1&&(this.constraints.R1=t.R1),"undefined"!=typeof t.X2&&(this.constraints.X2=t.X2),"undefined"!=typeof t.Y2&&(this.constraints.Y2=t.Y2),"undefined"!=typeof t.Z2&&(this.constraints.Z2=t.Z2),"undefined"!=typeof t.R2&&(this.constraints.R2=t.R2)},this.cameraController.prototype.SetOrigin=function(t,i){"undefined"!=typeof t&&(this.origin.X=t),"undefined"!=typeof i&&(this.origin.Y=i)},this.cameraController.prototype.Pan=function(t,i,e,n,s,o,a){this.PanX(t,e,s,o,a),this.PanY(i,n,s,o,a),debug&&debugMovement&&console.log("Pan: X:"+t+",Y:"+i)},this.cameraController.prototype.PanX=function(t,i,e,n,s){var o=this;if("undefined"==typeof e&&(e=.01),"undefined"==typeof s&&(s=!0),"undefined"==typeof n&&(n=!1),"undefined"==typeof i&&(i=this.camera.position.x),n||(t=i+t),this.HitTestX(t)&&!this.animating||!s){s||(this.animating=!0);var a=new TWEEN.Tween({x:i}).to({x:t},1e3*e).onUpdate(function(){o.camera.position.x=this.x}).onComplete(function(){o.animating=!1}).start()}debug&&debugMovement&&console.log("PanX:"+t)},this.cameraController.prototype.PanY=function(t,i,e,n,s){var o=this;if("undefined"==typeof e&&(e=.01),"undefined"==typeof s&&(s=!0),"undefined"==typeof n&&(n=!1),"undefined"==typeof i&&(i=this.camera.position.y),n||(t=i+t),this.HitTestY(t)&&!this.animating||!s){s||(this.animating=!0);var a=new TWEEN.Tween({y:i}).to({y:t},1e3*e).onUpdate(function(){o.camera.position.y=this.y}).onComplete(function(){o.animating=!1}).start()}debug&&debugMovement&&console.log("PanY:"+t)},this.cameraController.prototype.Zoom=function(t,i,e,n,s){var o=this;if("undefined"==typeof s&&(s=!0),"undefined"==typeof e&&(e=.01),"undefined"==typeof n&&(n=!1),"undefined"==typeof i&&(i=this.camera.position.z),n||(t=i+t),debug&&debugMovement&&console.log("Zoom: "+t),this.HitTestZ(t)&&!this.animating||!s){s||(this.animating=!0);var a=new TWEEN.Tween({z:i}).to({z:t},1e3*e).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){o.camera.position.z=this.z}).onComplete(function(){o.animating=!1}).start()}},this.cameraController.prototype.Move=function(t,i,e,n,s){"undefined"==typeof s&&(s=!0),"undefined"==typeof n&&(n=!0),n||(t=this.camera.position.x+t,i=this.camera.position.y+i,e=this.camera.position.z+e),"undefined"==typeof t||isNaN(t)||(this.HitTestX(t)&&!this.animating||!s||n)&&(this.camera.position.x=t),"undefined"==typeof i||isNaN(i)||(this.HitTestY(i)&&!this.animating||!s||n)&&(this.camera.position.y=i),"undefined"==typeof e||isNaN(e)||(this.HitTestZ(e)&&!this.animating||!s||n)&&(this.camera.position.z=e),debug&&debugMovement&&console.log("Move: X:"+t+",Y:"+i+",Z:"+e)},this.cameraController.prototype.Rotate=function(t,i,e,n){"undefined"==typeof n&&(n=!0),n||(t=this.camera.rotation.x+t,i=this.camera.rotation.y+i,e=this.camera.rotation.z+e),"undefined"==typeof t||isNaN(t)||this.HitTestR(t)&&!this.animating&&(this.camera.rotation.x=t),"undefined"==typeof i||isNaN(i)||this.HitTestR(i)&&!this.animating&&(this.camera.rotation.y=i),"undefined"==typeof e||isNaN(e)||this.HitTestR(e)&&!this.animating&&(this.camera.rotation.z=e),debug&&debugMovement&&console.log("Rotate: X:"+t+",Y:"+i+",Z:"+e)},this.cameraController.prototype.HitTestX=function(t){return t>=this.constraints.X1&&t<=this.constraints.X2},this.cameraController.prototype.HitTestY=function(t){return t>=this.constraints.Y1&&t<=this.constraints.Y2},this.cameraController.prototype.HitTestZ=function(t){return t>=this.constraints.Z1&&t<=this.constraints.Z2},this.cameraController.prototype.HitTestR=function(t){return t>=this.constraints.R1&&t<=this.constraints.R2},this.cityController=function(t){this.cities=[],this.city=void 0,this.dataController=t},this.cityController.prototype.SpawnCity=function(i,e,n,s,o,a,r){if("undefined"==typeof o&&(o=1),"undefined"==typeof a&&(a=0===this.cities.length?0:this.cities.length*this.cities[0].width*cityGutter),"undefined"==typeof r&&(r=0),o>1){var h=t.MultiplyArray(o,s);i*=o,e*=o,s=h}var d=new t.city(i,e,dataController,s,o,a,r);return d.tag=n,this.cities.push(d),d.index=this.cities.length,1==this.cities.length&&(this.city=d),d},this.cityController.prototype.SetCity=function(t){return"undefined"!=typeof t&&t.index&&t.index<=this.cities.length?(this.city=this.cities[t.index],1):(console.log("Error (cityController.SetCity): Tried to set a city with an out of range index"),0)},this.cityController.prototype.CityIsSpawned=function(t){return 0!==this.GetCityByTag(t)},this.cityController.prototype.SetCityByIndex=function(t){this.city=t<=this.cities.length?cities[t]:cities.length},this.cityController.prototype.SetCityByTag=function(t){var i=this.GetCityByTag(t);return i?(this.city=i,1):0},this.cityController.prototype.GetCityByID=function(t){return t<this.cities.length?this.cities[t]:city},this.cityController.prototype.GetCityByTag=function(t){if("string"==typeof t)for(var i in this.cities)if("undefined"!=typeof this.cities[i].tag&&this.cities[i].tag==t)return this.cities[i];return 0},this.city=function(t,i,e,n,s,o,a){this.logMatrix=function(t){if(debug)for(var i in t)for(var e in i)console.log(t[i][e])},this.index=void 0,this.tag="default",this.buildings=[],this.buildingData=n.slice(),this.extents={X1:void 0,Y1:void 0,X2:void 0,Y2:void 0,Z1:void 0,Z2:void 0},this.origin={X:o,Y:a},this.width=0,this.height=0,this.midpoint={X:0,Y:0},this.buildingsPerRow=t,this.buildingsPerColumn=i,this.dataRef=e,this.init3D()},this.city.prototype.init3D=function(){var i=gridSizex-boxwidth,e=gridSizey-boxheight,n=jitterX,s=jitterY;this.drawMatrix=math.zeros(this.buildingsPerRow,this.buildingsPerColumn),this.dataMatrix=math.zeros(1,this.buildingData.length),camMinHeight=0;for(var o=this.buildingData.length,a=!1,r=0,h=1;h<=this.buildingsPerColumn;h++){for(var d=this.buildingsPerRow;d>=1;d--){var u={},l=new t.building(this.buildingData[r]);if("undefined"==typeof l){a=!0;break}for(var c=!1,f=!1,p=0;p<l.xsize;p++){for(var y=0;y<l.ysize&&(h+y-1<this.buildingsPerColumn&&this.buildingsPerRow-d+p<this.buildingsPerRow?this.drawMatrix.subset(math.index(h+y-1,this.buildingsPerRow-d+p))>0&&(debug&&debugGrid&&console.log("found tile extending into occupied index"),f=!0,c=!0):c=!0,!c);y++);if(c)break}if(!f){for(var p=0;p<l.xsize;p++)for(var y=0;y<l.ysize;y++)h+y-1<this.buildingsPerColumn&&this.buildingsPerRow-d+p<this.buildingsPerRow&&this.drawMatrix.subset(math.index(h+y-1,this.buildingsPerRow-d+p),Math.max(l.xsize,l.ysize));this.buildingData.splice(r,1),n*=-1,s*=-1;var g=e*(l.ysize-1)+boxheight*l.ysize,m=i*(l.xsize-1)+boxwidth*l.xsize,x=Math.random()*buildingHeightVariance+1*boxdepth*10;x/2+1>camMinHeight&&(camMinHeight=Math.ceil(x/2+1)),u.geometry=new THREE.BoxGeometry(m,g,x);var b=parseInt(l.hex_color,16);if(u.material=this.dataRef.GetMaterial(l,b),u.cube=new THREE.Mesh(u.geometry,new THREE.MeshFaceMaterial(u.material)),u.cube.castShadow=!0,u.cube.receiveShadow=!0,u.cube.name=l.id,scene.add(u.cube),u.cube.position.x=this.origin.X+(-d*gridSizex- -(l.xsize-1)*gridSizex/2+n),u.cube.position.y=this.origin.Y+(-h*gridSizey-(l.ysize-1)*gridSizey/2+s),(u.cube.position.x+1.4*m<this.extents.X1||"number"!=typeof this.extents.X1)&&(this.extents.X1=u.cube.position.x+1.4*m),(u.cube.position.x-1.4*m>this.extents.X2||"number"!=typeof this.extents.X2)&&(this.extents.X2=u.cube.position.x-1.4*m),(u.cube.position.y+g/4<this.extents.Y1||"number"!=typeof this.extents.Y1)&&(this.extents.Y1=u.cube.position.y+g/4),(u.cube.position.y-g/4>this.extents.Y2||"number"!=typeof this.extents.Y2)&&(this.extents.Y2=u.cube.position.y-g/4),(u.cube.position.z-x/2<this.extents.Z1||"number"!=typeof this.extents.Z1)&&(this.extents.Z1=u.cube.position.z+x/3),l.SetModel(u.cube),this.buildings[parseInt(l.id)]=l,objects.push(u.cube),debug&&debugGrid&&this.logMatrix(this.drawMatrix),debug&&debugGrid&&this.logMatrix(this.dataMatrix),a)break}}if(a)break}this.midpoint.X=(this.extents.X2+this.extents.X1)/2,this.midpoint.Y=(this.extents.Y2+this.extents.Y1)/2,this.width=Math.abs(this.extents.X1-this.extents.X2),this.height=Math.abs(this.extents.Y1-this.extents.Y2),this.extents.Z2=this.extents.Z1+camZ2Extents},this.building=function(t){"undefined"!=typeof t&&(this.xsize="undefined"==typeof t.xsize?void 0:t.xsize,this.ysize="undefined"==typeof t.ysize?void 0:t.ysize,this.id="undefined"==typeof t.id?void 0:t.id,this.title="undefined"==typeof t.title?void 0:t.title,this.description="undefined"==typeof t.description?void 0:t.description,this.tags="undefined"==typeof t.tags?void 0:t.tags,this.img="undefined"==typeof t.img?void 0:t.img,this.hex_color="undefined"==typeof t.hex_color?void 0:t.hex_color),this.model=void 0},this.building.prototype.SetModel=function(t){this.model=t},this.clouds=function(){},this.clouds.prototype.Render=function(t){function i(){n=new THREE.Geometry;var t=THREE.ImageUtils.loadTexture("simg/cloud.png",null);t.magFilter=THREE.LinearMipMapLinearFilter,t.minFilter=THREE.LinearMipMapLinearFilter,s=new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:t},fogColor:{type:"c",value:4555956},fogNear:{type:"f",value:-100},fogFar:{type:"f",value:3e3}},vertexShader:document.getElementById("vs").textContent,fragmentShader:document.getElementById("fs").textContent,depthWrite:!1,depthTest:!1,transparent:!0});for(var i=new THREE.Mesh(new THREE.PlaneGeometry(64,64)),o=0;200>o;o++)i.position.x=1e3*Math.random()-500,i.position.y=-Math.random()*Math.random()*200-15,i.rotation.z=Math.random()*Math.Pi,i.scale.x=i.scale.y=Math.random()*Math.random()*1.5+.5,THREE.GeometryUtils.merge(n,i),console.log(i.position.z);e=new THREE.Mesh(n,s),scene.add(e),e=new THREE.Mesh(n,s),e.position.z=-200,scene.add(e)}var e,n,s;i()}};